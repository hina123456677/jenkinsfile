pipeline {
    agent any

    environment {
        BASE_GIT_URL = "https://github.com/hinaswan"
        GIT_CREDS   = "git-pat-creds"   // Jenkins Credentials ID

        IE_GLOBAL_TAG = "develop"
        IE_DEPS_TAG = "develop"
        IPS_BO_API_SPECS_TAG = "develop"
        BO_TAG = "develop"
        IPS_DSP_TAG = "develop"
        IPS_MESSAGES_CANONICAL_TAG = "develop"
        IPS_MESSAGES_ISO20022_TAG = "develop"
        MAPS_SERVICE_CONFIG_TAG = "develop"
        MAPS_CORE_TAG = "develop"
        DB_TAG = "develop"
        SACHSIM_UI_TAG = "develop"
        SWITCH_TAG = "develop"
        IPS_TRANSFORMER_TAG = "develop"
        LEGACY_TRANSFORMER_TAG = "develop"
        MAPS_TCH_TAG = "develop"
        RAMBUS_STE_CLIENT_TAG = "develop"
    }

    stages {

        stage('ie-global') {
            steps {
                dir('ie-global') {
                    git branch: IE_GLOBAL_TAG,
                        url: "${BASE_GIT_URL}/ie-global.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' clean install"
                }
            }
        }

        stage('ie-deps') {
            steps {
                dir('ie-deps') {
                    git branch: IE_DEPS_TAG,
                        url: "${BASE_GIT_URL}/ie-deps.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' clean install"
                }
            }
        }

        stage('ips-bo-api-specs') {
            steps {
                dir('ips-bo-api-specs') {
                    git branch: IPS_BO_API_SPECS_TAG,
                        url: "${BASE_GIT_URL}/ips-bo-api-specs.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }
            }
        }

        stage('ips-tch-backoffice') {
            steps {
                dir('ips-tch-backoffice') {
                    git branch: BO_TAG,
                        url: "${BASE_GIT_URL}/ips-tch-backoffice.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag,rpm,war' -DskipTests clean install"
                }
            }
        }

        stage('ips-dsp') {
            steps {
                dir('ips-dsp') {
                    git branch: IPS_DSP_TAG,
                        url: "${BASE_GIT_URL}/ips-dsp.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P rpm -P '!tag' -DskipTests clean install"
                }
            }
        }

        stage('messages') {
            steps {
                dir('ips-messages-canonical') {
                    git branch: IPS_MESSAGES_CANONICAL_TAG,
                        url: "${BASE_GIT_URL}/ips-messages-canonical.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }

                dir('ips-messages-iso20022') {
                    git branch: IPS_MESSAGES_ISO20022_TAG,
                        url: "${BASE_GIT_URL}/ips-messages-iso20022.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }
            }
        }

        stage('maps-service-config') {
            steps {
                dir('maps-service-config') {
                    git branch: MAPS_SERVICE_CONFIG_TAG,
                        url: "${BASE_GIT_URL}/maps-service-config.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }
            }
        }

        stage('maps-core') {
            steps {
                dir('ips-maps-core') {
                    git branch: MAPS_CORE_TAG,
                        url: "${BASE_GIT_URL}/ips-maps-core.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag,rpm' -DskipTests clean install"
                }
            }
        }

        stage('database') {
            steps {
                dir('ips-tch-database') {
                    git branch: DB_TAG,
                        url: "${BASE_GIT_URL}/ips-tch-database.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P rpm,war -DskipTests clean install"
                }
            }
        }

        stage('msim-ui') {
            steps {
                dir('ips-tch-msimui') {
                    git branch: SACHSIM_UI_TAG,
                        url: "${BASE_GIT_URL}/ips-tch-msimui.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag,rpm' -DskipTests clean install"
                }
            }
        }

        stage('switch') {
            steps {
                dir('ips-tch-switch') {
                    git branch: SWITCH_TAG,
                        url: "${BASE_GIT_URL}/ips-tch-switch.git",
                        credentialsId: GIT_CREDS
                    sh "./build.sh"
                }
            }
        }

        stage('transformers') {
            steps {
                dir('ips-tch-transformer') {
                    git branch: IPS_TRANSFORMER_TAG,
                        url: "${BASE_GIT_URL}/ips-tch-transformer.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag,rpm' -DskipTests clean install"
                }

                dir('ips-transformer') {
                    git branch: LEGACY_TRANSFORMER_TAG,
                        url: "${BASE_GIT_URL}/ips-transformer.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }
            }
        }

        stage('maps-tch & rambus') {
            steps {
                dir('maps-tch') {
                    git branch: MAPS_TCH_TAG,
                        url: "${BASE_GIT_URL}/maps-tch.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }

                dir('rambus-ste-client') {
                    git branch: RAMBUS_STE_CLIENT_TAG,
                        url: "${BASE_GIT_URL}/rambus-ste-client.git",
                        credentialsId: GIT_CREDS
                    sh "mvn -U -P '!tag' -DskipTests clean install"
                }
            }
        }
    }

    post {
        success {
            echo "✅ All services built successfully (secure & multi-user safe)"
        }
        failure {
            echo "❌ Build failed"
        }
    }
}